---
title: "Patients/Samples exploration for CH evolution project"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: console
---

<style type= "text/css">

. figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
```

```{r library}
library(tidyverse)
library(gtsummary)
library(labelled)
library(viridis)
library(kableExtra)
theme_set(theme_classic())
theme_gtsummary_compact()
```

```{r load}
tmn_blood <-
  read_rds(paste0(here::here(), 
                  "/data/processed_data",
                  "/Patients and samples data_2025-09-30.rds")) %>% 
  mutate(across(c(where(is_character),
                  -sample_id, -sample_type), ~ str_to_sentence(.)))

path_clinical <- fs::path("", "Volumes", "Gillis_Research", "Lab_Data", "CHEvolutionTMN")
# cancer_data <-
#   readxl::read_xlsx(paste0(here::here(), #path_clinical, 
#                            "/data/raw data/CHevolution_CohortRaw_10R25000197_v1_20250818.xlsx"), 
#                     # "/RawData/CHevolution_CohortRaw_10R25000197_v1_20250818.xlsx"), 
#                     sheet = "Registry_General") %>% 
#   janitor::clean_names()
```

```{r}
tmn_blood <- tmn_blood %>%
  filter(number_of_sample_bf_tmn > 2 |
           (primary_cancer_site_group == "Breast" & 
           number_of_sample_bf_tmn > 1))
```

```{r Labeling data}
var_label(tmn_blood) <- list(age_at_diagnosis = "Patient age", 
                             gender_src_desc = "Sex",
                             race_cr_src_desc_1 = "Race", 
                             cdsc_vital_status = "Vital status", 
                             os_time_from_dx_months = "Follow-up time (months)",
                             primary_cancer_treatment_type = "Primary cancer treatment type",
                             primary_cancer_site = "Primary cancer site", 
                             primary_cancer_site_group = "Primary cancer site group",
                             primary_cancer_histology = "Primary cancer histology", 
                             primary_cancer_grade_clin = "Primary cancer clinical grade (need abstraction)",
                             primary_cancer_grade_path = "Primary cancer pathological grade (need abstraction)", 
                             primary_cancer_grade_tnm = "Primary cancer TNM stage (need abstraction)",
                             time_primary_cancer_to_tmn_years = "Time primary cancer to TMN (years)",
         
                             tmn_site = "TMN site", 
                             tmn_site_group = "TMN site group", 
                             tmn_histology = "TMN histology",
                             
                             age_at_sample = "Age at first sample",     
                             number_of_sample_bf_tmn = "Number of sample before TMN"
)
```

<!-- # Checking histology -->
<!-- I just want to check some of the histology that are  -->
<!-- ```{r Checking histology} -->
<!-- cancer_data <- cancer_data %>%  -->
<!--   mutate(mrn = as.character(mrn)) %>%  -->
<!--   select(mrn : tumor_seq_num, birth_dt, dx_dt, initial_contact_dt, everything()) -->

<!-- # Patient exclusion based on histology info -->
<!-- cancer_data %>%  -->
<!--   filter(tumor_seq_num == "01") %>%  -->
<!--   select(histology_desc) %>%  -->
<!--   tbl_summary(sort = everything() ~ "frequency") -->

<!-- cancer_data1 <- cancer_data %>% -->
<!--   # Verify tumor_seq_num -->
<!--   mutate(tumor_seq_num = as.numeric(tumor_seq_num)) %>%  -->
<!--   group_by(mrn) %>%  -->
<!--   mutate(tumor_seq_num_verified = row_number(), # There is 1 wrong patient with a tumor_seq_num == 60 and 1 with 00 -->
<!--          .after = tumor_seq_num) %>%  -->
<!--   ungroup() %>%  -->
<!--   select(-tumor_seq_num) %>%  -->
<!--   # Exclude patients who only had myeloid diseases -->
<!--   mutate(exclude = case_when( -->
<!--     tumor_seq_num_verified == 1 & -->
<!--       histology_desc %in% c( -->
<!--         "REFRACTORY ANEMIA WITH EXCESS BLASTS",  -->
<!--         "MYELODYSPLASTIC SYNDROME NOS",  -->
<!--         "CHRONIC MYELOMONOCYTIC LEUKEMIA NOS",  -->
<!--         "POLYCYTHEMIA VERA")                             ~ "Exclude" -->
<!--   )) %>%  -->
<!--   group_by(mrn) %>%  -->
<!--   fill(exclude, .direction = "updown") %>%  -->
<!--   ungroup() %>%  -->
<!--   filter(is.na(exclude)) -->

<!-- cancer_data1 %>%  -->
<!--   filter(tumor_seq_num_verified > 1) %>%  -->
<!--   filter(primary_site_group_desc != "BLADDER", -->
<!--          primary_site_group_desc != "BREAST", -->
<!--          primary_site_group_desc != "MELANOMA OF SKIN", -->
<!--          primary_site_group_desc != "LUNG/BRONCHUS-SMALL CELL") %>%  -->
<!--   select(primary_site_group_desc, primary_site_desc, histology_desc) %>%  -->
<!--   tbl_summary(by = primary_site_group_desc, -->
<!--               sort = everything() ~ "frequency") %>%  -->
<!--   modify_spanning_header(everything() ~ "primary_site_group_desc") -->
<!-- ``` -->

<!-- What I am using right now. -->
<!-- ```{r} -->
<!-- tmn_blood %>%  -->
<!--   select(tmn_primary_site_group_desc, tmn_primary_site_desc, tmn_histology_desc) %>%  -->
<!--   tbl_summary(by = tmn_primary_site_group_desc, -->
<!--               sort = everything() ~ "frequency") %>%  -->
<!--   bold_labels() %>%  -->
<!--   modify_spanning_header(everything() ~ "tmn_primary_site_group_desc") -->
<!-- ``` -->


# Data exploration
## Patient Characteristics (focus on patients with more than 2 samples and more than 1 sample for breast cancer patients)
I have 14 patients who have at least 3 samples before TMN (or at least 2 samples for breast cancer patients).   
I added some variables like stage which are not cleaned but I don't know if we are going to be able to combine the stage from different cancer type. They also have a lot of missing values so I think we will re-abstract them...
```{r Patient Characteristics}
tmn_blood %>% 
  filter(sample_sequence_number == 1) %>% 
  select(age_at_diagnosis, gender_src_desc, race_cr_src_desc_1,
         cdsc_vital_status,
         os_time_from_dx_months,
         
         primary_cancer_treatment_type,
         primary_cancer_site, primary_cancer_site_group,
         primary_cancer_histology, primary_cancer_grade_clin,
         primary_cancer_grade_path, primary_cancer_grade_tnm,
         time_primary_cancer_to_tmn_years,

         tmn_site, tmn_site_group, tmn_histology,

         age_at_sample,
         `Time from primary cancer to first sample (days)` = interval_primary_cancer_to_samples_days,
         `Time from first sample to TMN (days)` = interval_sample_to_tmn_days,
         number_of_sample_bf_tmn
         # sample_sequence_number,
         ) %>% 
  tbl_summary(sort = list(all_categorical() ~ "frequency")) %>%
  bold_labels() %>%
  modify_header(label ~ "**Patient characteristics**",
                all_stat_cols() ~ "**{level}**, N = {n}")
```
<br>

<!-- ## 1.Time between first diagnosis and TMN -->
<!-- ```{r} -->
<!-- tmn_blood %>%  -->
<!--   filter(blood_bf_tmn == "Yes") %>%  -->
<!--   filter(sample_sequence_number == 1) %>%  -->
<!--   ggplot(aes(x = time_dx_tmn))+ -->
<!--   geom_histogram(binwidth = 7, alpha = 0.9, position = "stack", fill= "orchid") + -->
<!--   labs(x="Time between first diagnosis and TMN (Days)", -->
<!--        y="Number of patients", -->
<!--        caption = "Each bar represents 7 days") -->
<!-- ``` -->

## 1.Time from blood collection to TMN
```{r}
pltly <- tmn_blood %>% 
  mutate(text = paste("Patient: ", mrn, 
                      "\nTime from blood collection to TMN (Days): ", interval_sample_to_tmn_days, 
                      "\nPrimary cancer site group: ", primary_cancer_site_group, 
                      "\nSample: ", sample_type, 
                      sep="")) %>%
  ggplot(aes(y = interval_sample_to_tmn_days, x = sample_sequence_number,
             color= mrn, group = mrn, text=text))+
  geom_point() +
  geom_line()+
  scale_y_continuous(labels = c("0" = "TMN = 0", 1000, 2000, 3000, 4000, 5000))+
  labs(x="Sample number",
       y="Time from blood collection to TMN (Days)",
       caption = "Sample 1 is the farthest from TMN - explain why the curves go down")
pltly

library(plotly)
pltly <- ggplotly(pltly, tooltip="text")
pltly
```




<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r, fig.height=6} -->
<!-- tmn_blood %>%  -->
<!--   filter(sample_sequence_number == 1) %>%  -->
<!--   ggplot(aes(x = interval_sample_to_tmn_days))+ -->
<!--   geom_histogram(binwidth = 7, alpha = 0.9, position = "stack", fill= "blue") + -->
<!--   labs(x = "Time from first blood collection to TMN (Days)", -->
<!--        y = "Number of patients", -->
<!--        caption = "Each bar represents 7 days") + -->
<!--   theme(text = element_text(size = 18)) -->
<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r, fig.height=6} -->
<!-- tmn_blood %>%  -->
<!--   filter(sample_sequence_number == 1) %>%  -->
<!--   ggplot(aes(x= blood_bf_tmn, y = interval_sample_to_tmn_days))+ -->
<!--   geom_boxplot(fill= "blue")+ -->
<!--   geom_jitter()+ -->
<!--   labs(y = "Time (Days)", -->
<!--        title = "Time from first blood collection to TMN (Days)")+ -->
<!--   theme(axis.title.x = element_blank(),  -->
<!--         axis.ticks.x = element_blank(),  -->
<!--         axis.text.x = element_blank()) + -->
<!--   theme(text = element_text(size = 18)) -->
<!-- ``` -->
<!-- </div> -->
<!-- </div> -->

<!-- <br> -->

```{r}
tmn_blood %>% 
  ggplot(aes(x = interval_sample_to_tmn_days, fill= factor(sample_sequence_number)))+
  geom_histogram(binwidth = 90, alpha = 0.9, position = "stack") +
  scale_fill_viridis(discrete=T, name = "Sample number")+
  labs(x="Time from blood collection to TMN (Days - all samples included)",
       y="Number of patients",
       caption = "Each bar represents 90 days")

tmn_blood %>% 
  select(sample_sequence_number,
         `Time from blood collection to TMN (Days - all samples included)` = interval_sample_to_tmn_days) %>% 
  tbl_summary(by = sample_sequence_number,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})")) %>% 
  bold_labels() %>%
  modify_spanning_header(everything() ~ "Time blood to TMN for each sequential sample")
```

## 2.Time from diagnosis to blood collection
<!-- <div class = "row"> -->
<!-- <div class = "col-md-6"> -->
<!-- ```{r, fig.height=6} -->
<!-- tmn_blood %>%  -->
<!--   filter(sample_sequence_number == 1) %>%  -->
<!--   ggplot(aes(x = interval_primary_cancer_to_samples_days))+ -->
<!--   geom_histogram(binwidth = 7, alpha = 0.9, position = "stack", fill= "red") + -->
<!--   theme_minimal(base_size = 14) + -->
<!--   labs(x = "Time from primary cancer to first blood collection (Days)", -->
<!--        y = "Number of patients", -->
<!--        caption = "Each bar represents 7 days") + -->
<!--   theme(text = element_text(size = 18)) -->
<!-- ``` -->
<!-- </div> -->

<!-- <div class = "col-md-6"> -->
<!-- ```{r, fig.height=6} -->
<!-- tmn_blood %>%  -->
<!--   filter(sample_sequence_number == 1) %>%  -->
<!--   ggplot(aes(x= blood_bf_tmn, y = interval_primary_cancer_to_samples_days))+ -->
<!--   geom_boxplot(fill= "red")+ -->
<!--   geom_jitter()+ -->
<!--   labs(y = "Time (Days)", -->
<!--        title = "Time from primary cancer to \nfirst blood collection (Days)")+ -->
<!--   theme(axis.title.x = element_blank(),  -->
<!--         axis.ticks.x = element_blank(),  -->
<!--         axis.text.x = element_blank()) + -->
<!--   theme(text = element_text(size = 18)) -->
<!-- ``` -->
<!-- </div> -->
<!-- </div> -->

<!-- <br> -->

```{r}
# tmn_blood %>% 
#   ggplot(aes(x = interval_primary_cancer_to_samples_days, fill= factor(sample_sequence_number)))+
#   geom_histogram(binwidth = 90, alpha = 0.9, position = "stack") +
#   scale_fill_viridis(discrete=T, name = "Sample number")+
#   labs(x="Time from Diagnosis to blood collection (Days - all samples included)",
#        y="Number of patients",
#        caption = "Each bar represents 90 days")

tmn_blood %>% 
  select(sample_sequence_number,
         `Time from primary cancer to blood collection (Days)`= interval_primary_cancer_to_samples_days) %>% 
  tbl_summary(by = sample_sequence_number,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})")) %>% 
  bold_labels() %>%
  modify_spanning_header(everything() ~ "Time primary cancer to blood for each sequential sample")
```

## 3.Time between samples
```{r}
# tmn_blood %>% 
#   mutate(sample_sequence_number = case_when(
#     sample_sequence_number == 2             ~ "1-2",
#     sample_sequence_number == 3             ~ "2-3",
#     sample_sequence_number == 4             ~ "3-4",
#     sample_sequence_number == 5             ~ "4-5",
#   )) %>% 
#   ggplot(aes(x = sample_lag_days, fill= sample_sequence_number))+
#   geom_histogram(binwidth = 90, 
#                  alpha = 0.9, position = "stack") +
#   scale_fill_viridis(discrete=T, name = "Lag between sample number")+
#   labs(x="Time between each blood collection (days)",
#        y="Number of patients",
#        caption = "Each bar represents 90 days")

tmn_blood %>% 
  mutate(sample_sequence_number = case_when(
    sample_sequence_number == 2             ~ "1-2",
    sample_sequence_number == 3             ~ "2-3",
    sample_sequence_number == 4             ~ "3-4",
    sample_sequence_number == 5             ~ "4-5",
  )) %>% 
  select(`Time between each blood collection (days)`= sample_lag_days,
         sample_sequence_number) %>% 
  tbl_summary(by = sample_sequence_number,
              statistic = list(all_continuous() ~ "{median} ({min}, {max})")) %>% 
  bold_labels() %>%
  modify_spanning_header(everything() ~ "Time between blood for each sequential sample")
```

# List of patients/samples
```{r}
tmn_blood <-
  tmn_blood %>% 
  group_by(mrn) %>% 
  mutate(ID = cur_group_id()) %>%
  ungroup() %>% 
  select(ID, everything())

color.me1 <- which((tmn_blood$ID %% 2) == 1)
color.me2 <- which((tmn_blood$sample_sequence_number %% 2) == 1)

tmn_blood %>% 
  select(mrn, sample_id, "sample\nsequence\nnumber" = sample_sequence_number, 
         "interval\nsample to\ntmn (days)" = interval_sample_to_tmn_days,
         "best\nanatomic\nsite" = best_anatomic_site) %>%
  kableExtra::kable(booktabs = T, align = "ccl") %>%
  kableExtra::row_spec(color.me1, background = "grey95") %>%
  kableExtra::row_spec(color.me2, color = "grey50")


# write_csv(tmn_blood %>% select(mrn, primary_cancer_site, primary_cancer_site_group, 
#                                primary_cancer_histology_code, primary_cancer_histology,
#                                tmn_site, tmn_site_group, tmn_histology_code, tmn_histology) %>% 
#             distinct(), 
#           "Patient info selected for project.csv")
# write_csv(tmn_blood %>% select(mrn, sample_id,
#                                sample_family_id, interval_sample_to_tmn_days,
#                                best_anatomic_site, sample_type),
#           "Patient samples info selected for project_093025.csv")

```










